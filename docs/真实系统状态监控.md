# 真实系统状态监控功能

## 功能概述

除了演示性的可视化外，现在添加了**真实的系统状态查询和监控**功能，可以获取系统运行时的实际数据。

## 与演示可视化的区别

### 演示可视化（旧）

- `os::process::visualization::run_all_demos()` - **创建演示进程**，然后显示
- `os::fs::visualization::run_all_demos()` - **创建演示文件**，然后显示
- **目的**：教学演示，展示功能如何工作

### 真实状态监控（新）

- `os::process::inspector::show_system_dashboard()` - 显示**真实运行中的进程**
- `os::fs::inspector::show_filesystem_dashboard()` - 显示**实际存在的文件**
- **目的**：系统监控，查看实际系统状态

## 新增文件

```
os/src/process/
└── inspector.rs        # 进程系统状态查询和监控

os/src/fs/
└── inspector.rs        # 文件系统状态查询和监控

docs/
└── 真实系统状态监控.md  # 本文档
```

## 进程系统监控API

### 1. 查询所有进程

```rust
use os::process::inspector;

// 获取所有进程的快照
let processes = inspector::get_all_processes();

for proc in processes {
    println!("PID: {}, 名称: {}, 状态: {:?}",
             proc.pid, proc.name, proc.state);
}
```

### 2. 获取系统统计

```rust
// 获取系统统计信息
let stats = inspector::get_system_stats();

println!("总进程数: {}", stats.total_processes);
println!("运行中: {}", stats.running_processes);
println!("就绪: {}", stats.ready_processes);
println!("阻塞: {}", stats.blocked_processes);
println!("僵尸: {}", stats.zombie_processes);
```

### 3. 显示完整仪表盘

```rust
// 显示进程系统监控仪表盘
inspector::show_system_dashboard();
```

**输出示例**：
```
████████████████████████████████████████████████████████████
█                                                          █
█          操作系统实时监控仪表盘                          █
█                                                          █
████████████████████████████████████████████████████████████

╔════════════════════════════════════════════════════════════╗
║                  系统统计信息（实时）                      ║
╠════════════════════════════════════════════════════════════╣
║  总进程数:        7                                        ║
║  运行中:          1                                        ║
║  就绪:            6                                        ║
║  阻塞:            0                                        ║
║  僵尸:            0                                        ║
╚════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════╗
║                  当前运行进程（实时）                      ║
╠════════════════════════════════════════════════════════════╣
║  PID:           1                                          ║
║  名称:        init                                         ║
║  状态:        运行中                                       ║
║  父进程PID:     0                                          ║
╚════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════╗
║                  系统进程列表（实时）                      ║
╠════════════════════════════════════════════════════════════╣
║  PID  │  名称              │  状态      │  父PID         ║
╠═══════╪════════════════════╪════════════╪════════════════╣
║    1  │  init              │  运行中    │      -         ║
║    2  │  shell             │  就绪      │      1         ║
║    3  │  test_proc         │  就绪      │      1         ║
╚════════════════════════════════════════════════════════════╝
```

## 文件系统监控API

### 1. 查询根目录文件

```rust
use os::fs::inspector;

// 获取根目录下所有文件和目录
let entries = inspector::get_root_entries();

for entry in entries {
    println!("Inode: {}, 名称: {}, 类型: {:?}, 大小: {}",
             entry.ino, entry.name, entry.file_type, entry.size);
}
```

### 2. 查询FD表使用情况

```rust
// 获取已分配的文件描述符
let fds = inspector::get_allocated_fds();

for fd_snap in fds {
    println!("FD {}: {}", fd_snap.fd, fd_snap.name);
}

// 获取FD统计
let stats = inspector::get_fd_stats();
println!("总FD数: {}", stats.total_fds);
println!("文件FD数: {}", stats.file_fds);
```

### 3. 显示文件系统仪表盘

```rust
// 显示文件系统监控仪表盘
inspector::show_filesystem_dashboard();
```

**输出示例**：
```
████████████████████████████████████████████████████████████
█                                                          █
█         文件系统实时监控仪表盘                           █
█                                                          █
████████████████████████████████████████████████████████████

╔════════════════════════════════════════════════════════════╗
║              FD表统计信息（实时）                          ║
╠════════════════════════════════════════════════════════════╣
║  总FD数:         5                                         ║
║  Stdin (0):     已分配                                     ║
║  Stdout (1):    已分配                                     ║
║  Stderr (2):    已分配                                     ║
║  文件FD数:       2                                         ║
╚════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════╗
║              文件描述符表（实时）                          ║
╠════════════════════════════════════════════════════════════╣
║   FD   │  文件/设备                                        ║
╠════════╪═══════════════════════════════════════════════════╣
║    0   │  Stdin                                            ║
║    1   │  Stdout                                           ║
║    2   │  Stderr                                           ║
║    3   │  File-3                                           ║
║    4   │  File-4                                           ║
╚════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════╗
║                根目录文件列表（实时）                      ║
╠════════════════════════════════════════════════════════════╣
║  Inode │  名称              │  类型    │  大小(B)       ║
╠════════╪════════════════════╪══════════╪════════════════╣
║    2  │  hello.txt          │  文件    │      0        ║
║    3  │  demo2_data.txt     │  文件    │     30        ║
║    4  │  demo3_fd_test.txt  │  文件    │      0        ║
║    5  │  demo4_docs         │  目录    │      0        ║
║    8  │  demo5_seek.txt     │  文件    │     20        ║
╚════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════╗
║              文件系统树结构（实时）                        ║
╠════════════════════════════════════════════════════════════╣
║                                                            ║
║  / (root, ino=1)                                           ║
║  ├──  hello.txt (ino=2, 0B)                                ║
║  ├──  demo2_data.txt (ino=3, 30B)                          ║
║  ├──  demo3_fd_test.txt (ino=4, 0B)                        ║
║  ├──  demo4_docs/ (ino=5, 0B)                              ║
║  │   ├──  readme.txt                                       ║
║  │   └──  todo.txt                                         ║
║  └──  demo5_seek.txt (ino=8, 20B)                          ║
║                                                            ║
╚════════════════════════════════════════════════════════════╝
```

## 运行程序查看效果

```bash
cd /Users/weisiyang/Blog_OS/os
cargo run
```

程序将：
1. 运行演示（创建演示进程和文件）
2. **显示真实系统状态**（展示刚才创建的进程和文件）

## 应用场景

### 1. 系统调试

查看当前有哪些进程在运行，它们的状态是什么：

```rust
inspector::show_process_list();
```

### 2. 资源监控

统计系统资源使用情况：

```rust
let stats = inspector::get_system_stats();
if stats.zombie_processes > 0 {
    println!("警告：有僵尸进程需要清理！");
}
```

### 3. 文件系统审计

查看文件系统中实际存在哪些文件：

```rust
inspector::show_filesystem_tree();
```

### 4. FD泄漏检测

检查是否有文件描述符没有正确关闭：

```rust
let fd_stats = inspector::get_fd_stats();
if fd_stats.file_fds > 预期数量 {
    println!("可能存在FD泄漏！");
}
```

## 与演示模式对比

| 特性 | 演示模式 (visualization) | 监控模式 (inspector) |
|------|-------------------------|---------------------|
| 数据来源 | 临时创建的演示数据 | 系统实际运行数据 |
| 目的 | 教学和功能演示 | 系统状态监控和调试 |
| 何时使用 | 学习OS工作原理时 | 调试和监控系统时 |
| 数据真实性 | 演示性数据 | 100%真实 |
| 典型场景 | 展示如何创建进程/文件 | 查看当前有哪些进程/文件 |

## 扩展建议

可以进一步添加：

1. **进程性能监控**
   - CPU使用率
   - 内存使用量
   - I/O统计

2. **文件系统性能**
   - 文件打开/关闭频率
   - 磁盘I/O统计
   - 缓存命中率

3. **实时更新**
   - 定时刷新监控数据
   - 显示变化趋势

4. **警告和告警**
   - 进程数过多
   - FD泄漏
   - 僵尸进程积累
